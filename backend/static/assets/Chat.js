import{j as s,M as L,r as V}from"./markdown-vendor.js";import{r as i}from"./react-vendor.js";import{g as re,c as q,a as z,s as le,b as Q,d as oe}from"./index.js";function xe({configVersion:U,currentConversationId:M,onConversationChange:g,onRefreshConversations:S}){const[p,E]=i.useState(""),[h,m]=i.useState([]),[b,x]=i.useState([]),[y,R]=i.useState(""),[N,_]=i.useState(!1),[O,v]=i.useState(""),[P,I]=i.useState(""),[W,u]=i.useState(""),[X,T]=i.useState(!1),[K,Y]=i.useState(""),H=i.useRef(null),D=i.useRef(Date.now());i.useEffect(()=>{if(M){const e=re(M);if(e){E(e.id);const r=e.messages.filter(t=>"role"in t);m(r),x(e.messages)}}else if(!p){const e=q();E(e.id),m([]),x([]),g==null||g(e.id)}},[M]),i.useEffect(()=>{if(p&&h.length>0){const e=z(h),r=[];let t=[];b.forEach(l=>{"type"in l&&l.type==="sources"?t.push(l):"role"in l&&(l.role==="user"&&t.length>0&&(r.push(...t),t=[]),r.push(l),l.role==="assistant"&&t.length>0&&(r.push(...t),t=[]))}),t.length>0&&r.push(...t),le({id:p,title:e,messages:r,createdAt:parseInt(p.split("_")[1])||Date.now(),updatedAt:Date.now()})}},[h,p,b]);const Z=()=>{const e=q();E(e.id),m([]),x([]),g==null||g(e.id),S==null||S()},ee=()=>{if(p&&h.length>0){const e=z(h),r=[];let t=[];b.forEach(l=>{"type"in l&&l.type==="sources"?t.push(l):"role"in l&&(l.role==="user"&&t.length>0&&(r.push(...t),t=[]),r.push(l),l.role==="assistant"&&t.length>0&&(r.push(...t),t=[]))}),t.length>0&&r.push(...t),oe({title:e,messages:r,createdAt:parseInt(p.split("_")[1])||Date.now()})}},se=()=>{var e;(e=H.current)==null||e.scrollIntoView({behavior:"smooth"})};i.useEffect(()=>{se()},[b]),i.useEffect(()=>{const e=Q(),r=!e.use_default_model&&!e.api_key;T(r)},[U]),i.useEffect(()=>{fetch("/NOTICE.md").then(e=>e.text()).then(e=>Y(e)).catch(e=>console.warn("Failed to load NOTICE.md:",e))},[]);const J=async()=>{var l;if(!y.trim()||N)return;const e=Q();if(!e.use_default_model&&!e.api_key){T(!0);return}T(!1);const r={role:"user",content:y};m(f=>[...f,r]),x(f=>[...f,r]),R(""),_(!0),v(""),I(""),u("");let t=!1;try{const f=h.slice(-(e.context_length*2)),$=new AbortController,te=setTimeout(()=>$.abort(),20*60*1e3),B=await fetch("/api/v1/rag/chat/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:y,conversation:f,config:e}),signal:$.signal});if(clearTimeout(te),!B.ok)throw new Error("è¯·æ±‚å¤±è´¥");const j=(l=B.body)==null?void 0:l.getReader(),ne=new TextDecoder;let A="";D.current=Date.now();let C=!1;const F=setInterval(()=>{const k=Date.now()-D.current;k>5*60*1e3&&!C&&(C=!0,I("å·²5åˆ†é’Ÿæ— å“åº”ï¼Œå¯èƒ½é—®é¢˜è¿‡äºå¤æ‚ã€‚å»ºè®®è°ƒå°ä¸Šä¸‹æ–‡è½®æ¬¡ã€ä½¿ç”¨éæ¨ç†æ¨¡å‹ã€æˆ–åœ¨æ–°æ ‡ç­¾é¡µå¼€å¯æ–°å¯¹è¯")),k>20*60*1e3&&(clearInterval(F),j==null||j.cancel(),v("è¿æ¥è¶…æ—¶ï¼ˆ20åˆ†é’Ÿæ— å“åº”ï¼‰"),I(""),_(!1))},1e3);for(;j;){const{done:k,value:ae}=await j.read();if(k){clearInterval(F);break}D.current=Date.now(),A+=ne.decode(ae,{stream:!0});const G=A.split(`
`);A=G.pop()||"";for(const w of G){if(w.startsWith(":")){switch(w.slice(1).trim()){case"connected":u("å·²è¿æ¥ï¼Œå‡†å¤‡ä¸­...");break;case"chat_engine_created":u("å¯¹è¯å¼•æ“å·²å°±ç»ªï¼Œæ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...");break;case"retrieval_done":u("æ£€ç´¢å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆå›ç­”...");break;case"sources_sent":u("å·²è·å–å¼•ç”¨æ¥æº...");break;case"generating":u("æ­£åœ¨ç”Ÿæˆå›ç­”...");break;case"heartbeat":u("æ­£åœ¨æ·±å…¥æ€è€ƒä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...");break;case"completed":u("");break}continue}if(w.startsWith("data: "))try{const c=JSON.parse(w.slice(6));if(c.type==="sources")x(o=>[...o,{type:"sources",sources:c.data}]);else if(c.type==="reasoning")if(t)m(n=>{const a=[...n],d=a[a.length-1];return d&&d.role==="assistant"?[...n.slice(0,-1),{...d,reasoning:(d.reasoning||"")+c.data,isReasoning:!0}]:a}),x(n=>{for(let a=n.length-1;a>=0;a--){const d=n[a];if("role"in d&&d.role==="assistant")return[...n.slice(0,a),{...d,reasoning:(d.reasoning||"")+c.data,isReasoning:!0},...n.slice(a+1)]}return n});else{t=!0;const o={role:"assistant",content:"",reasoning:c.data,isReasoning:!0};m(n=>[...n,o]),x(n=>[...n,o])}else if(c.type==="token")if(t)m(o=>{const n=[...o],a=n[n.length-1];return a&&a.role==="assistant"?[...o.slice(0,-1),{...a,content:a.content+c.data,isReasoning:!1}]:n}),x(o=>{for(let n=o.length-1;n>=0;n--){const a=o[n];if("role"in a&&a.role==="assistant")return[...o.slice(0,n),{...a,content:a.content+c.data,isReasoning:!1},...o.slice(n+1)]}return o});else{t=!0;const o={role:"assistant",content:c.data};m(n=>[...n,o]),x(n=>[...n,o])}else c.type==="done"?x(o=>{const n=[...o];for(let a=n.length-1;a>=0;a--){const d=n[a];if("type"in d&&d.type==="sources"){d.tokens=c.data.tokens;break}}return[...n]}):c.type==="error"&&v(c.data)}catch{console.warn("è§£æ SSE å¤±è´¥:",w)}}}}catch(f){v(f instanceof Error?f.message:"ç½‘ç»œé”™è¯¯")}finally{_(!1),u("")}};return s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsxs("div",{className:"border-b border-gray-200 p-6 pl-16 lg:pl-6 flex items-center justify-between",children:[s.jsx("h2",{className:"text-2xl font-semibold",children:"çŸ¥è¯†åº“é—®ç­”"}),s.jsxs("div",{className:"flex gap-2",children:[h.length>0&&s.jsx("button",{onClick:ee,className:"px-3 py-1.5 text-sm bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors text-blue-700 font-medium",title:"ä¸‹è½½å¯¹è¯ä¸ºçº¯æ–‡æœ¬",children:"ğŸ’¾ ä¸‹è½½å¯¹è¯"}),s.jsx("button",{onClick:Z,className:"px-3 py-1.5 text-sm bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-colors font-medium",children:"âœ¨ æ–°å¯¹è¯"})]})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[b.length===0&&s.jsxs("div",{className:"text-center text-slate-700 mt-20",children:[s.jsx("div",{className:"text-lg font-medium",children:"ä½ å¥½ï¼æˆ‘æ˜¯åƒæ˜ŸçŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ"}),s.jsx("div",{className:"text-sm mt-2 text-slate-500",children:"å¯¹è¯å°†è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼Œå»ºè®®åŠæ—¶åˆ é™¤"}),s.jsx("div",{className:"text-sm mt-2 text-slate-500",children:"åœ¨èœå•å·¦ä¸‹è§’æŒ‰éœ€å‡å°‘ä¸Šä¸‹æ–‡è½®æ¬¡å¯åŠ å¿«ç”Ÿæˆé€Ÿåº¦"}),K.trim()&&s.jsx("div",{className:"mt-8 max-w-2xl mx-auto bg-green-50 border border-green-200 rounded-xl p-6 text-left",children:s.jsx("div",{className:"prose prose-sm max-w-none prose-slate",children:s.jsx(L,{remarkPlugins:[V],children:K})})})]}),X&&s.jsx("div",{className:"text-center px-4",children:s.jsxs("div",{className:"inline-block bg-yellow-50 border border-yellow-200 rounded-xl px-6 py-4 text-sm max-w-md",children:[s.jsx("div",{className:"text-yellow-800 mb-2 font-medium",children:"âš ï¸ è¯·å…ˆé…ç½® API Key"}),s.jsxs("div",{className:"text-yellow-600",children:["è¯·ç‚¹å‡»",s.jsx("span",{className:"hidden lg:inline",children:"å·¦ä¸‹è§’"}),s.jsx("span",{className:"lg:hidden",children:"èœå•ä¸­"}),"ã€Œâš™ï¸ OpenAI é…ç½®ã€æŒ‰é’®è¿›è¡Œé…ç½®ï¼ˆæˆ–å‹¾é€‰å…è´¹æ¨¡å‹ï¼‰"]})]})}),b.map((e,r)=>"type"in e&&e.type==="sources"?s.jsx("div",{className:"flex justify-start",children:s.jsxs("div",{className:"max-w-2xl px-4 py-3 rounded-2xl bg-blue-50 text-gray-900",children:[s.jsx("div",{className:"font-semibold mb-2 text-sm",children:"ğŸ“š å¼•ç”¨æ¥æº"}),e.sources.map((t,l)=>s.jsxs("div",{className:"mb-2 pb-2 border-b border-blue-100 last:border-0",children:[s.jsx("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline font-medium text-sm",children:t.title}),s.jsxs("span",{className:"text-gray-500 ml-2 text-xs",children:["(",Math.round(t.similarity*100),"%)"]}),t.text_snippet&&s.jsxs("div",{className:"text-gray-600 text-xs mt-1",children:[t.text_snippet.substring(0,100),"..."]})]},l)),e.tokens&&e.tokens>0&&s.jsxs("div",{className:"text-gray-500 text-xs mt-2",children:["ğŸ’¬ æ¶ˆè€— tokens: ",e.tokens]})]})},r):s.jsx("div",{className:`flex ${"role"in e&&e.role==="user"?"justify-end":"justify-start"}`,children:s.jsx("div",{className:`max-w-2xl px-4 py-3 rounded-2xl ${"role"in e&&e.role==="user"?"bg-amber-50 text-slate-900 border border-amber-50":"bg-gray-100 text-gray-900"}`,children:"role"in e&&e.role==="user"?s.jsx("div",{className:"whitespace-pre-wrap",children:"content"in e?e.content:""}):s.jsxs("div",{className:"prose prose-sm max-w-none prose-slate",children:["reasoning"in e&&e.reasoning&&s.jsxs("details",{className:"mb-4 border border-gray-200 rounded-lg bg-white overflow-hidden",open:e.isReasoning,children:[s.jsx("summary",{className:"px-4 py-2 bg-gray-50 cursor-pointer text-xs font-medium text-gray-500 hover:bg-gray-100 select-none flex items-center",children:s.jsx("span",{children:"ğŸ’­ æ€è€ƒè¿‡ç¨‹"})}),s.jsx("div",{className:"px-4 py-3 text-gray-600 text-sm bg-gray-50/50 whitespace-pre-wrap border-t border-gray-100",children:e.reasoning})]}),s.jsx(L,{remarkPlugins:[V],children:"content"in e?e.content:""})]})})},r)),W&&s.jsx("div",{className:"text-center px-4",children:s.jsx("div",{className:"inline-block bg-blue-50 border border-blue-200 rounded-xl px-6 py-3 text-sm text-blue-700 animate-pulse",children:W})}),P&&s.jsx("div",{className:"text-center px-4",children:s.jsxs("div",{className:"inline-block bg-orange-50 border border-orange-200 rounded-xl px-6 py-4 text-sm max-w-2xl",children:[s.jsx("div",{className:"text-orange-800 mb-2 font-medium",children:"â±ï¸ å“åº”è¾ƒæ…¢"}),s.jsx("div",{className:"text-orange-600",children:P})]})}),O&&s.jsx("div",{className:"text-center text-red-500 text-sm",children:O}),s.jsx("div",{ref:H})]}),s.jsxs("div",{className:"border-t border-gray-200 p-6",children:[s.jsxs("div",{className:"flex gap-3",children:[s.jsx("input",{type:"text",value:y,onChange:e=>R(e.target.value),onKeyPress:e=>e.key==="Enter"&&!e.shiftKey&&J(),placeholder:"è¾“å…¥ä½ çš„é—®é¢˜...(AIå›ç­”ä»…ä¾›å‚è€ƒ)",disabled:N,className:"flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-yellow-300"}),s.jsx("button",{onClick:J,disabled:N||!y.trim(),className:"px-6 py-3 bg-yellow-300 text-slate-900 rounded-xl hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium shadow-sm",children:N?"...":"å‘é€"})]}),s.jsx("div",{className:"text-center text-xs text-gray-500 mt-3",children:"ã€ŠåŸç¥ã€‹åƒæ˜Ÿå¥‡åŸŸç›¸å…³æ–‡æ¡£ç‰ˆæƒå½’ç±³å“ˆæ¸¸æ‰€æœ‰ï¼Œæœ¬ç½‘ç«™ä¸ºä¸ªäººå…´è¶£ï¼Œä»…ä¾›è¾…åŠ©ä¸ªäººå…´è¶£ä½¿ç”¨ï¼Œä¸ç±³å“ˆæ¸¸æ— å…³"})]})]})}export{xe as default};
