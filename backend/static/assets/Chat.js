import{j as s,M as se,r as te}from"./markdown-vendor.js";import{r as c}from"./react-vendor.js";import{g as ae,c as V,a as q,s as ne,b as z,d as re}from"./index.js";function ce({configVersion:F,currentConversationId:M,onConversationChange:h,onRefreshConversations:S}){const[p,_]=c.useState(""),[g,m]=c.useState([]),[b,x]=c.useState([]),[y,R]=c.useState(""),[N,E]=c.useState(!1),[W,v]=c.useState(""),[O,I]=c.useState(""),[P,u]=c.useState(""),[Q,T]=c.useState(!1),K=c.useRef(null),D=c.useRef(Date.now());c.useEffect(()=>{if(M){const e=ae(M);if(e){_(e.id);const i=e.messages.filter(n=>"role"in n);m(i),x(e.messages)}}else if(!p){const e=V();_(e.id),m([]),x([]),h==null||h(e.id)}},[M]),c.useEffect(()=>{if(p&&g.length>0){const e=q(g),i=[];let n=[];b.forEach(l=>{"type"in l&&l.type==="sources"?n.push(l):"role"in l&&(i.push(l),l.role==="assistant"&&n.length>0&&(i.push(...n),n=[]))}),ne({id:p,title:e,messages:i,createdAt:parseInt(p.split("_")[1])||Date.now(),updatedAt:Date.now()})}},[g,p,b]);const U=()=>{const e=V();_(e.id),m([]),x([]),h==null||h(e.id),S==null||S()},X=()=>{if(p&&g.length>0){const e=q(g),i=[];let n=[];b.forEach(l=>{"type"in l&&l.type==="sources"?n.push(l):"role"in l&&(i.push(l),l.role==="assistant"&&n.length>0&&(i.push(...n),n=[]))}),re({title:e,messages:i,createdAt:parseInt(p.split("_")[1])||Date.now()})}},Y=()=>{var e;(e=K.current)==null||e.scrollIntoView({behavior:"smooth"})};c.useEffect(()=>{Y()},[b]),c.useEffect(()=>{const e=z(),i=!e.use_default_model&&!e.api_key;T(i)},[F]);const H=async()=>{var l;if(!y.trim()||N)return;const e=z();if(!e.use_default_model&&!e.api_key){T(!0);return}T(!1);const i={role:"user",content:y};m(f=>[...f,i]),x(f=>[...f,i]),R(""),E(!0),v(""),I(""),u("");let n=!1;try{const f=g.slice(-(e.context_length*2)),J=new AbortController,Z=setTimeout(()=>J.abort(),20*60*1e3),$=await fetch("/api/v1/rag/chat/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:y,conversation:f,config:e}),signal:J.signal});if(clearTimeout(Z),!$.ok)throw new Error("è¯·æ±‚å¤±è´¥");const j=(l=$.body)==null?void 0:l.getReader(),C=new TextDecoder;let A="";D.current=Date.now();let B=!1;const G=setInterval(()=>{const k=Date.now()-D.current;k>5*60*1e3&&!B&&(B=!0,I("å·²5åˆ†é’Ÿæ— å“åº”ï¼Œå¯èƒ½é—®é¢˜è¿‡äºå¤æ‚ã€‚å»ºè®®è°ƒå°ä¸Šä¸‹æ–‡è½®æ¬¡ã€ä½¿ç”¨éæ¨ç†æ¨¡å‹ã€æˆ–åœ¨æ–°æ ‡ç­¾é¡µå¼€å¯æ–°å¯¹è¯")),k>20*60*1e3&&(clearInterval(G),j==null||j.cancel(),v("è¿æ¥è¶…æ—¶ï¼ˆ20åˆ†é’Ÿæ— å“åº”ï¼‰"),I(""),E(!1))},1e3);for(;j;){const{done:k,value:ee}=await j.read();if(k){clearInterval(G);break}D.current=Date.now(),A+=C.decode(ee,{stream:!0});const L=A.split(`
`);A=L.pop()||"";for(const w of L){if(w.startsWith(":")){switch(w.slice(1).trim()){case"connected":u("å·²è¿æ¥ï¼Œå‡†å¤‡ä¸­...");break;case"chat_engine_created":u("å¯¹è¯å¼•æ“å·²å°±ç»ªï¼Œæ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...");break;case"retrieval_done":u("æ£€ç´¢å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆå›ç­”...");break;case"sources_sent":u("å·²è·å–å¼•ç”¨æ¥æº...");break;case"generating":u("æ­£åœ¨ç”Ÿæˆå›ç­”...");break;case"heartbeat":u("æ­£åœ¨æ·±å…¥æ€è€ƒä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...");break;case"completed":u("");break}continue}if(w.startsWith("data: "))try{const o=JSON.parse(w.slice(6));if(o.type==="sources")x(r=>[...r,{type:"sources",sources:o.data}]);else if(o.type==="reasoning")if(n)m(t=>{const a=[...t],d=a[a.length-1];return d&&d.role==="assistant"?[...t.slice(0,-1),{...d,reasoning:(d.reasoning||"")+o.data,isReasoning:!0}]:a}),x(t=>{for(let a=t.length-1;a>=0;a--){const d=t[a];if("role"in d&&d.role==="assistant")return[...t.slice(0,a),{...d,reasoning:(d.reasoning||"")+o.data,isReasoning:!0},...t.slice(a+1)]}return t});else{n=!0;const r={role:"assistant",content:"",reasoning:o.data,isReasoning:!0};m(t=>[...t,r]),x(t=>[...t,r])}else if(o.type==="token")if(n)m(r=>{const t=[...r],a=t[t.length-1];return a&&a.role==="assistant"?[...r.slice(0,-1),{...a,content:a.content+o.data,isReasoning:!1}]:t}),x(r=>{for(let t=r.length-1;t>=0;t--){const a=r[t];if("role"in a&&a.role==="assistant")return[...r.slice(0,t),{...a,content:a.content+o.data,isReasoning:!1},...r.slice(t+1)]}return r});else{n=!0;const r={role:"assistant",content:o.data};m(t=>[...t,r]),x(t=>[...t,r])}else o.type==="done"?x(r=>{const t=[...r];for(let a=t.length-1;a>=0;a--){const d=t[a];if("type"in d&&d.type==="sources"){d.tokens=o.data.tokens;break}}return[...t]}):o.type==="error"&&v(o.data)}catch{console.warn("è§£æ SSE å¤±è´¥:",w)}}}}catch(f){v(f instanceof Error?f.message:"ç½‘ç»œé”™è¯¯")}finally{E(!1),u("")}};return s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsxs("div",{className:"border-b border-gray-200 p-6 pl-16 lg:pl-6 flex items-center justify-between",children:[s.jsx("h2",{className:"text-2xl font-semibold",children:"çŸ¥è¯†åº“é—®ç­”"}),s.jsxs("div",{className:"flex gap-2",children:[g.length>0&&s.jsx("button",{onClick:X,className:"px-3 py-1.5 text-sm bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors text-blue-700 font-medium",title:"ä¸‹è½½å¯¹è¯ä¸ºçº¯æ–‡æœ¬",children:"ğŸ’¾ ä¸‹è½½å¯¹è¯"}),s.jsx("button",{onClick:U,className:"px-3 py-1.5 text-sm bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-colors font-medium",children:"âœ¨ æ–°å¯¹è¯"})]})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[b.length===0&&s.jsxs("div",{className:"text-center text-slate-700 mt-20",children:[s.jsx("div",{className:"text-lg font-medium",children:"ä½ å¥½ï¼æˆ‘æ˜¯åƒæ˜ŸçŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ"}),s.jsx("div",{className:"text-sm mt-2 text-slate-500",children:"å¯¹è¯å°†è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼Œå»ºè®®åŠæ—¶åˆ é™¤"}),s.jsx("div",{className:"text-sm mt-2 text-slate-500",children:"åœ¨å·¦ä¸‹è§’èœå•æŒ‰éœ€å‡å°‘ä¸Šä¸‹æ–‡è½®æ¬¡å¯åŠ å¿«ç”Ÿæˆé€Ÿåº¦"})]}),Q&&s.jsx("div",{className:"text-center px-4",children:s.jsxs("div",{className:"inline-block bg-yellow-50 border border-yellow-200 rounded-xl px-6 py-4 text-sm max-w-md",children:[s.jsx("div",{className:"text-yellow-800 mb-2 font-medium",children:"âš ï¸ è¯·å…ˆé…ç½® API Key"}),s.jsxs("div",{className:"text-yellow-600",children:["è¯·ç‚¹å‡»",s.jsx("span",{className:"hidden lg:inline",children:"å·¦ä¸‹è§’"}),s.jsx("span",{className:"lg:hidden",children:"èœå•ä¸­"}),"ã€Œâš™ï¸ OpenAI é…ç½®ã€æŒ‰é’®è¿›è¡Œé…ç½®ï¼ˆæˆ–å‹¾é€‰å…è´¹æ¨¡å‹ï¼‰"]})]})}),b.map((e,i)=>"type"in e&&e.type==="sources"?s.jsx("div",{className:"flex justify-start",children:s.jsxs("div",{className:"max-w-2xl px-4 py-3 rounded-2xl bg-blue-50 text-gray-900",children:[s.jsx("div",{className:"font-semibold mb-2 text-sm",children:"ğŸ“š å¼•ç”¨æ¥æº"}),e.sources.map((n,l)=>s.jsxs("div",{className:"mb-2 pb-2 border-b border-blue-100 last:border-0",children:[s.jsx("a",{href:n.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline font-medium text-sm",children:n.title}),s.jsxs("span",{className:"text-gray-500 ml-2 text-xs",children:["(",Math.round(n.similarity*100),"%)"]}),n.text_snippet&&s.jsxs("div",{className:"text-gray-600 text-xs mt-1",children:[n.text_snippet.substring(0,100),"..."]})]},l)),e.tokens&&e.tokens>0&&s.jsxs("div",{className:"text-gray-500 text-xs mt-2",children:["ğŸ’¬ æ¶ˆè€— tokens: ",e.tokens]})]})},i):s.jsx("div",{className:`flex ${"role"in e&&e.role==="user"?"justify-end":"justify-start"}`,children:s.jsx("div",{className:`max-w-2xl px-4 py-3 rounded-2xl ${"role"in e&&e.role==="user"?"bg-amber-50 text-slate-900 border border-amber-50":"bg-gray-100 text-gray-900"}`,children:"role"in e&&e.role==="user"?s.jsx("div",{className:"whitespace-pre-wrap",children:"content"in e?e.content:""}):s.jsxs("div",{className:"prose prose-sm max-w-none prose-slate",children:["reasoning"in e&&e.reasoning&&s.jsxs("details",{className:"mb-4 border border-gray-200 rounded-lg bg-white overflow-hidden",open:e.isReasoning,children:[s.jsx("summary",{className:"px-4 py-2 bg-gray-50 cursor-pointer text-xs font-medium text-gray-500 hover:bg-gray-100 select-none flex items-center",children:s.jsx("span",{children:"ğŸ’­ æ€è€ƒè¿‡ç¨‹"})}),s.jsx("div",{className:"px-4 py-3 text-gray-600 text-sm bg-gray-50/50 whitespace-pre-wrap border-t border-gray-100",children:e.reasoning})]}),s.jsx(se,{remarkPlugins:[te],children:"content"in e?e.content:""})]})})},i)),P&&s.jsx("div",{className:"text-center px-4",children:s.jsx("div",{className:"inline-block bg-blue-50 border border-blue-200 rounded-xl px-6 py-3 text-sm text-blue-700 animate-pulse",children:P})}),O&&s.jsx("div",{className:"text-center px-4",children:s.jsxs("div",{className:"inline-block bg-orange-50 border border-orange-200 rounded-xl px-6 py-4 text-sm max-w-2xl",children:[s.jsx("div",{className:"text-orange-800 mb-2 font-medium",children:"â±ï¸ å“åº”è¾ƒæ…¢"}),s.jsx("div",{className:"text-orange-600",children:O})]})}),W&&s.jsx("div",{className:"text-center text-red-500 text-sm",children:W}),s.jsx("div",{ref:K})]}),s.jsxs("div",{className:"border-t border-gray-200 p-6",children:[s.jsxs("div",{className:"flex gap-3",children:[s.jsx("input",{type:"text",value:y,onChange:e=>R(e.target.value),onKeyPress:e=>e.key==="Enter"&&!e.shiftKey&&H(),placeholder:"è¾“å…¥ä½ çš„é—®é¢˜...(AIå›ç­”ä»…ä¾›å‚è€ƒ)",disabled:N,className:"flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-yellow-300"}),s.jsx("button",{onClick:H,disabled:N||!y.trim(),className:"px-6 py-3 bg-yellow-300 text-slate-900 rounded-xl hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium shadow-sm",children:N?"...":"å‘é€"})]}),s.jsx("div",{className:"text-center text-xs text-gray-500 mt-3",children:"ã€ŠåŸç¥ã€‹åƒæ˜Ÿå¥‡åŸŸç›¸å…³æ–‡æ¡£ç‰ˆæƒå½’ç±³å“ˆæ¸¸æ‰€æœ‰ï¼Œæœ¬ç½‘ç«™ä¸ºä¸ªäººå…´è¶£ï¼Œä»…è¾…åŠ©å¼€å‘ä½¿ç”¨ï¼Œä¸ç±³å“ˆæ¸¸æ— å…³"})]})]})}export{ce as default};
