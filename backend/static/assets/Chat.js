import{j as t,M as te,r as se}from"./markdown-vendor.js";import{r as i}from"./react-vendor.js";import{g as he,c as ae,a as ne,s as fe,b as re,d as pe}from"./index.js";function je({configVersion:le,currentConversationId:O,onConversationChange:k,onRefreshConversations:C}){const[w,W]=i.useState(""),[j,f]=i.useState([]),[M,m]=i.useState([]),[I,J]=i.useState(""),[E,K]=i.useState(!1),[q,N]=i.useState(""),[z,L]=i.useState(""),[V,g]=i.useState(""),[ie,F]=i.useState(!1),[X,oe]=i.useState(""),[H,A]=i.useState(null),[_,R]=i.useState(null),[U,D]=i.useState(""),Z=i.useRef(null),$=i.useRef(Date.now());i.useEffect(()=>{if(O){const e=he(O);if(e){W(e.id);const a=e.messages.filter(s=>"role"in s);f(a),m(e.messages)}}else if(!w){const e=ae();W(e.id),f([]),m([]),k==null||k(e.id)}},[O]),i.useEffect(()=>{if(w&&j.length>0){const e=ne(j),a=[];let s=[];M.forEach(r=>{"type"in r&&r.type==="sources"?s.push(r):"role"in r&&(r.role==="user"&&s.length>0&&(a.push(...s),s=[]),a.push(r),r.role==="assistant"&&s.length>0&&(a.push(...s),s=[]))}),s.length>0&&a.push(...s),fe({id:w,title:e,messages:a,createdAt:parseInt(w.split("_")[1])||Date.now(),updatedAt:Date.now()})}},[j,w,M]);const Q=1024*1024,ce=e=>new Promise((a,s)=>{const r=new FileReader;r.onload=()=>{const d=new Image;d.onload=()=>{const p=document.createElement("canvas"),B=p.getContext("2d");if(!B){s(new Error("Canvas ä¸æ”¯æŒ"));return}let{width:h,height:u}=d;const S=1280;if(h>S||u>S){const v=Math.min(S/h,S/u);h=Math.round(h*v),u=Math.round(u*v)}p.width=h,p.height=u,B.drawImage(d,0,0,h,u);let b=.9,y=p.toDataURL("image/jpeg",b);for(;y.length*.75>Q&&b>.3;)b-=.1,y=p.toDataURL("image/jpeg",b);const P=Math.round(y.length*.75/1024);y.length*.75>Q?s(new Error("å›¾ç‰‡å‹ç¼©åä»å¤§äº 1MBï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡")):a({base64:y,info:`å·²å‹ç¼©è‡³çº¦ ${P} KB`})},d.onerror=()=>s(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥")),d.src=r.result},r.onerror=()=>s(new Error("è¯»å–å›¾ç‰‡å¤±è´¥")),r.readAsDataURL(e)}),G=async e=>{if(!e){A(null),R(null),D("");return}if(!e.type.startsWith("image/")){N("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶");return}try{N(""),D("æ­£åœ¨å‹ç¼©å›¾ç‰‡...");const{base64:a,info:s}=await ce(e);A(a),R(a),D(s)}catch(a){A(null),R(null),D(""),N(a instanceof Error?a.message:"å›¾ç‰‡å¤„ç†å¤±è´¥")}},de=e=>{const a=e.clipboardData.items;for(let s=0;s<a.length;s++)if(a[s].type.indexOf("image")!==-1){const r=a[s].getAsFile();if(r){e.preventDefault(),G(r);return}}},xe=()=>{const e=ae();W(e.id),f([]),m([]),k==null||k(e.id),C==null||C()},ue=()=>{if(w&&j.length>0){const e=ne(j),a=[];let s=[];M.forEach(r=>{"type"in r&&r.type==="sources"?s.push(r):"role"in r&&(r.role==="user"&&s.length>0&&(a.push(...s),s=[]),a.push(r),r.role==="assistant"&&s.length>0&&(a.push(...s),s=[]))}),s.length>0&&a.push(...s),pe({title:e,messages:a,createdAt:parseInt(w.split("_")[1])||Date.now()})}},me=()=>{var e;(e=Z.current)==null||e.scrollIntoView({behavior:"smooth"})};i.useEffect(()=>{me()},[M]),i.useEffect(()=>{const e=re(),a=!e.use_default_model&&!e.api_key;F(a)},[le]),i.useEffect(()=>{fetch("/NOTICE.md").then(e=>e.text()).then(e=>oe(e)).catch(e=>console.warn("Failed to load NOTICE.md:",e))},[]);const Y=async()=>{var r;if(!I.trim()&&!_||E)return;const e=re();if(!e.use_default_model&&!e.api_key){F(!0);return}F(!1);const a={role:"user",content:I||(_?"[å›¾ç‰‡æé—®]":""),imageBase64:_||void 0};f(d=>[...d,a]),m(d=>[...d,a]),J(""),A(null),R(null),D(""),K(!0),N(""),L(""),g("");let s=!1;try{const d=j.slice(-(e.context_length*2)),p=new AbortController,B=setTimeout(()=>p.abort(),20*60*1e3),h=await fetch("/api/v1/rag/chat/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:I,conversation:d,config:e,image_base64:_}),signal:p.signal});if(clearTimeout(B),!h.ok)throw new Error("è¯·æ±‚å¤±è´¥");const u=(r=h.body)==null?void 0:r.getReader(),S=new TextDecoder;let b="";$.current=Date.now();let y=!1;const P=setInterval(()=>{const v=Date.now()-$.current;v>5*60*1e3&&!y&&(y=!0,L("å·²5åˆ†é’Ÿæ— å“åº”ï¼Œå¯èƒ½é—®é¢˜è¿‡äºå¤æ‚ã€‚å»ºè®®è°ƒå°ä¸Šä¸‹æ–‡è½®æ¬¡ã€ä½¿ç”¨éæ¨ç†æ¨¡å‹ã€æˆ–åœ¨æ–°æ ‡ç­¾é¡µå¼€å¯æ–°å¯¹è¯")),v>20*60*1e3&&(clearInterval(P),u==null||u.cancel(),N("è¿æ¥è¶…æ—¶ï¼ˆ20åˆ†é’Ÿæ— å“åº”ï¼‰"),L(""),K(!1))},1e3);for(;u;){const{done:v,value:ge}=await u.read();if(v){clearInterval(P);break}$.current=Date.now(),b+=S.decode(ge,{stream:!0});const ee=b.split(`
`);b=ee.pop()||"";for(const T of ee){if(T.startsWith(":")){switch(T.slice(1).trim()){case"connected":g("å·²è¿æ¥ï¼Œå‡†å¤‡ä¸­...");break;case"chat_engine_created":g("å¯¹è¯å¼•æ“å·²å°±ç»ªï¼Œæ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...");break;case"retrieval_done":g("æ£€ç´¢å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆå›ç­”...");break;case"sources_sent":g("å·²è·å–å¼•ç”¨æ¥æº...");break;case"generating":g("æ­£åœ¨ç”Ÿæˆå›ç­”...");break;case"heartbeat":g("æ­£åœ¨æ·±å…¥æ€è€ƒä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...");break;case"completed":g("");break}continue}if(T.startsWith("data: "))try{const c=JSON.parse(T.slice(6));if(c.type==="sources")m(o=>[...o,{type:"sources",sources:c.data}]);else if(c.type==="reasoning")if(s)f(n=>{const l=[...n],x=l[l.length-1];return x&&x.role==="assistant"?[...n.slice(0,-1),{...x,reasoning:(x.reasoning||"")+c.data,isReasoning:!0}]:l}),m(n=>{for(let l=n.length-1;l>=0;l--){const x=n[l];if("role"in x&&x.role==="assistant")return[...n.slice(0,l),{...x,reasoning:(x.reasoning||"")+c.data,isReasoning:!0},...n.slice(l+1)]}return n});else{s=!0;const o={role:"assistant",content:"",reasoning:c.data,isReasoning:!0};f(n=>[...n,o]),m(n=>[...n,o])}else if(c.type==="token")if(s)f(o=>{const n=[...o],l=n[n.length-1];return l&&l.role==="assistant"?[...o.slice(0,-1),{...l,content:l.content+c.data,isReasoning:!1}]:n}),m(o=>{for(let n=o.length-1;n>=0;n--){const l=o[n];if("role"in l&&l.role==="assistant")return[...o.slice(0,n),{...l,content:l.content+c.data,isReasoning:!1},...o.slice(n+1)]}return o});else{s=!0;const o={role:"assistant",content:c.data};f(n=>[...n,o]),m(n=>[...n,o])}else c.type==="done"?m(o=>{const n=[...o];for(let l=n.length-1;l>=0;l--){const x=n[l];if("type"in x&&x.type==="sources"){x.tokens=c.data.tokens;break}}return[...n]}):c.type==="error"&&N(c.data)}catch{console.warn("è§£æ SSE å¤±è´¥:",T)}}}}catch(d){N(d instanceof Error?d.message:"ç½‘ç»œé”™è¯¯")}finally{K(!1),g("")}};return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"border-b border-gray-200 p-6 pl-16 lg:pl-6 flex items-center justify-between",children:[t.jsx("h2",{className:"text-2xl font-semibold",children:"çŸ¥è¯†åº“é—®ç­”"}),t.jsxs("div",{className:"flex gap-2",children:[j.length>0&&t.jsx("button",{onClick:ue,className:"px-3 py-1.5 text-sm bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors text-blue-700 font-medium",title:"ä¸‹è½½å¯¹è¯ä¸ºçº¯æ–‡æœ¬",children:"ğŸ’¾ ä¸‹è½½å¯¹è¯"}),t.jsx("button",{onClick:xe,className:"px-3 py-1.5 text-sm bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-colors font-medium",children:"âœ¨ æ–°å¯¹è¯"})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[M.length===0&&t.jsxs("div",{className:"text-center text-slate-700 mt-20",children:[t.jsx("div",{className:"text-lg font-medium",children:"ä½ å¥½ï¼æˆ‘æ˜¯åƒæ˜ŸçŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ"}),t.jsx("div",{className:"text-sm mt-2 text-slate-500",children:"å¯¹è¯å°†è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼Œå»ºè®®åŠæ—¶åˆ é™¤"}),t.jsx("div",{className:"text-sm mt-2 text-slate-500",children:"åœ¨èœå•å·¦ä¸‹è§’æŒ‰éœ€å‡å°‘ä¸Šä¸‹æ–‡è½®æ¬¡å¯åŠ å¿«ç”Ÿæˆé€Ÿåº¦"}),X.trim()&&t.jsx("div",{className:"mt-8 max-w-2xl mx-auto bg-green-50 border border-green-200 rounded-xl p-6 text-left",children:t.jsx("div",{className:"prose prose-sm max-w-none prose-slate",children:t.jsx(te,{remarkPlugins:[se],children:X})})})]}),ie&&t.jsx("div",{className:"text-center px-4",children:t.jsxs("div",{className:"inline-block bg-yellow-50 border border-yellow-200 rounded-xl px-6 py-4 text-sm max-w-md",children:[t.jsx("div",{className:"text-yellow-800 mb-2 font-medium",children:"âš ï¸ è¯·å…ˆé…ç½® API Key"}),t.jsxs("div",{className:"text-yellow-600",children:["è¯·ç‚¹å‡»",t.jsx("span",{className:"hidden lg:inline",children:"å·¦ä¸‹è§’"}),t.jsx("span",{className:"lg:hidden",children:"èœå•ä¸­"}),"ã€Œâš™ï¸ OpenAI é…ç½®ã€æŒ‰é’®è¿›è¡Œé…ç½®ï¼ˆæˆ–å‹¾é€‰å…è´¹æ¨¡å‹ï¼‰"]})]})}),M.map((e,a)=>"type"in e&&e.type==="sources"?t.jsx("div",{className:"flex justify-start",children:t.jsxs("div",{className:"max-w-2xl px-4 py-3 rounded-2xl bg-blue-50 text-gray-900",children:[t.jsx("div",{className:"font-semibold mb-2 text-sm",children:"ğŸ“š å¼•ç”¨æ¥æº"}),e.sources.map((s,r)=>t.jsxs("div",{className:"mb-2 pb-2 border-b border-blue-100 last:border-0",children:[t.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline font-medium text-sm",children:s.title}),t.jsxs("span",{className:"text-gray-500 ml-2 text-xs",children:["(",Math.round(s.similarity*100),"%)"]}),s.text_snippet&&t.jsxs("div",{className:"text-gray-600 text-xs mt-1",children:[s.text_snippet.substring(0,100),"..."]})]},r)),e.tokens&&e.tokens>0&&t.jsxs("div",{className:"text-gray-500 text-xs mt-2",children:["ğŸ’¬ æ¶ˆè€— tokens: ",e.tokens]})]})},a):t.jsx("div",{className:`flex ${"role"in e&&e.role==="user"?"justify-end":"justify-start"}`,children:t.jsx("div",{className:`max-w-2xl px-4 py-3 rounded-2xl ${"role"in e&&e.role==="user"?"bg-amber-50 text-slate-900 border border-amber-50":"bg-gray-100 text-gray-900"}`,children:"role"in e&&e.role==="user"?t.jsxs("div",{className:"whitespace-pre-wrap",children:["imageBase64"in e&&e.imageBase64&&t.jsx("div",{className:"mb-2",children:t.jsx("img",{src:e.imageBase64,alt:"ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡",className:"max-w-full h-auto rounded-lg border border-white/20",style:{maxHeight:"300px"}})}),"content"in e?e.content:""]}):t.jsxs("div",{className:"prose prose-sm max-w-none prose-slate",children:["reasoning"in e&&e.reasoning&&t.jsxs("details",{className:"mb-4 border border-gray-200 rounded-lg bg-white overflow-hidden",open:e.isReasoning,children:[t.jsx("summary",{className:"px-4 py-2 bg-gray-50 cursor-pointer text-xs font-medium text-gray-500 hover:bg-gray-100 select-none flex items-center",children:t.jsx("span",{children:"ğŸ’­ æ€è€ƒè¿‡ç¨‹"})}),t.jsx("div",{className:"px-4 py-3 text-gray-600 text-sm bg-gray-50/50 whitespace-pre-wrap border-t border-gray-100",children:e.reasoning})]}),t.jsx(te,{remarkPlugins:[se],children:"content"in e?e.content:""})]})})},a)),V&&t.jsx("div",{className:"text-center px-4",children:t.jsx("div",{className:"inline-block bg-blue-50 border border-blue-200 rounded-xl px-6 py-3 text-sm text-blue-700 animate-pulse",children:V})}),z&&t.jsx("div",{className:"text-center px-4",children:t.jsxs("div",{className:"inline-block bg-orange-50 border border-orange-200 rounded-xl px-6 py-4 text-sm max-w-2xl",children:[t.jsx("div",{className:"text-orange-800 mb-2 font-medium",children:"â±ï¸ å“åº”è¾ƒæ…¢"}),t.jsx("div",{className:"text-orange-600",children:z})]})}),q&&t.jsx("div",{className:"text-center text-red-500 text-sm",children:q}),t.jsx("div",{ref:Z})]}),t.jsxs("div",{className:"border-t border-gray-200 p-6",children:[t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("label",{className:"px-3 py-3 border border-dashed border-gray-300 rounded-xl bg-white/60 text-sm text-gray-600 cursor-pointer hover:border-yellow-400 hover:bg-white",children:[t.jsx("span",{children:"ğŸ“· å›¾ç‰‡"}),t.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:e=>G(e.target.files&&e.target.files[0]?e.target.files[0]:null),disabled:E})]}),t.jsx("input",{type:"text",value:I,onChange:e=>J(e.target.value),onKeyPress:e=>e.key==="Enter"&&!e.shiftKey&&Y(),onPaste:de,placeholder:"è¾“å…¥é—®é¢˜æˆ–ç²˜è´´å›¾ç‰‡ï¼›AIå›ç­”ä»…ä¾›å‚è€ƒï¼Œè¯·ä¿æŒè´¨ç–‘ï¼Œä¼˜å…ˆæŸ¥çœ‹æ¥æºä¸­çš„å®˜æ–¹æ–‡æ¡£",disabled:E,className:"flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-yellow-300"}),t.jsx("button",{onClick:Y,disabled:E||!I.trim()&&!_,className:"px-6 py-3 bg-yellow-300 text-slate-900 rounded-xl hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium shadow-sm",children:E?"...":"å‘é€"})]}),H&&t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("img",{src:H,alt:"å·²é€‰æ‹©çš„å›¾ç‰‡",className:"w-16 h-16 object-cover rounded-lg border border-gray-200"}),t.jsxs("div",{className:"flex-1 text-xs text-gray-600",children:[t.jsxs("div",{children:["å·²é™„å¸¦å›¾ç‰‡å‘é€ï¼ˆ",U||"å¤§å°ä¿¡æ¯è®¡ç®—ä¸­...","ï¼‰"]}),t.jsx("button",{type:"button",onClick:()=>G(null),className:"mt-1 text-xs text-red-500 hover:underline",disabled:E,children:"ç§»é™¤å›¾ç‰‡"})]})]}),!H&&U&&t.jsx("div",{className:"text-xs text-gray-500",children:U})]}),t.jsx("div",{className:"text-center text-xs text-gray-500 mt-3",children:"ã€ŠåŸç¥ã€‹åƒæ˜Ÿå¥‡åŸŸç›¸å…³æ–‡æ¡£ç‰ˆæƒå½’ç±³å“ˆæ¸¸æ‰€æœ‰ï¼Œæœ¬ç½‘ç«™ä¸ºä¸ªäººå…´è¶£ï¼Œä»…ä¾›è¾…åŠ©ä¸ªäººå…´è¶£ä½¿ç”¨ï¼Œä¸ç±³å“ˆæ¸¸æ— å…³"})]})]})}export{je as default};
